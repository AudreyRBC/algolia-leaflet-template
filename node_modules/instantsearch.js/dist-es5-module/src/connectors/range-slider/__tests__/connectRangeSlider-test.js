'use strict';

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _algoliasearchHelper = require('algoliasearch-helper');

var _algoliasearchHelper2 = _interopRequireDefault(_algoliasearchHelper);

var _connectRangeSlider = require('../connectRangeSlider.js');

var _connectRangeSlider2 = _interopRequireDefault(_connectRangeSlider);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var SearchResults = _algoliasearchHelper2.default.SearchResults;

var fakeClient = { addAlgoliaAgent: function addAlgoliaAgent() {} };

describe('connectRangeSlider', function () {
  it('Renders during init and render', function () {
    // test that the dummyRendering is called with the isFirstRendering
    // flag set accordingly
    var rendering = _sinon2.default.stub();
    var makeWidget = (0, _connectRangeSlider2.default)(rendering);

    var attributeName = 'price';
    var widget = makeWidget({
      attributeName: attributeName
    });

    var config = widget.getConfiguration();
    expect(config).toEqual({
      disjunctiveFacets: [attributeName]
    });

    var helper = (0, _algoliasearchHelper2.default)(fakeClient, '', config);
    helper.search = _sinon2.default.stub();

    widget.init({
      helper: helper,
      state: helper.state,
      createURL: function createURL() {
        return '#';
      },
      onHistoryChange: function onHistoryChange() {}
    });

    {
      // should call the rendering once with isFirstRendering to true
      expect(rendering.callCount).toBe(1);
      var isFirstRendering = rendering.lastCall.args[1];
      expect(isFirstRendering).toBe(true);

      // should provide good values for the first rendering
      var _rendering$lastCall$a = rendering.lastCall.args[0],
          range = _rendering$lastCall$a.range,
          start = _rendering$lastCall$a.start,
          widgetParams = _rendering$lastCall$a.widgetParams;

      expect(range).toEqual({ min: 0, max: 0 });
      expect(start).toEqual([-Infinity, Infinity]);
      expect(widgetParams).toEqual({
        attributeName: attributeName
      });
    }

    widget.render({
      results: new SearchResults(helper.state, [{
        hits: [{ test: 'oneTime' }],
        facets: { price: { 10: 1, 20: 1, 30: 1 } },
        facets_stats: { // eslint-disable-line
          price: {
            avg: 20,
            max: 30,
            min: 10,
            sum: 60
          }
        },
        nbHits: 1,
        nbPages: 1,
        page: 0
      }]),
      state: helper.state,
      helper: helper,
      createURL: function createURL() {
        return '#';
      }
    });

    {
      // Should call the rendering a second time, with isFirstRendering to false
      expect(rendering.callCount).toBe(2);
      var _isFirstRendering = rendering.lastCall.args[1];
      expect(_isFirstRendering).toBe(false);

      // should provide good values for the first rendering
      var _rendering$lastCall$a2 = rendering.lastCall.args[0],
          _range = _rendering$lastCall$a2.range,
          _start = _rendering$lastCall$a2.start;

      expect(_range).toEqual({ min: 10, max: 30 });
      expect(_start).toEqual([-Infinity, Infinity]);
    }
  });

  it('Accepts some user bounds', function () {
    var makeWidget = (0, _connectRangeSlider2.default)(function () {});

    var attributeName = 'price';

    expect(makeWidget({ attributeName: attributeName, min: 0 }).getConfiguration()).toEqual({
      disjunctiveFacets: [attributeName],
      numericRefinements: _defineProperty({}, attributeName, { '>=': [0] })
    });

    expect(makeWidget({ attributeName: attributeName, max: 100 }).getConfiguration()).toEqual({
      disjunctiveFacets: [attributeName],
      numericRefinements: _defineProperty({}, attributeName, { '<=': [100] })
    });

    expect(makeWidget({ attributeName: attributeName, min: 0, max: 100 }).getConfiguration()).toEqual({
      disjunctiveFacets: [attributeName],
      numericRefinements: _defineProperty({}, attributeName, {
        '>=': [0],
        '<=': [100]
      })
    });
  });

  it('Provides a function to update the refinements at each step', function () {
    var rendering = _sinon2.default.stub();
    var makeWidget = (0, _connectRangeSlider2.default)(rendering);

    var attributeName = 'price';
    var widget = makeWidget({
      attributeName: attributeName
    });

    var helper = (0, _algoliasearchHelper2.default)(fakeClient, '', widget.getConfiguration());
    helper.search = _sinon2.default.stub();

    widget.init({
      helper: helper,
      state: helper.state,
      createURL: function createURL() {
        return '#';
      },
      onHistoryChange: function onHistoryChange() {}
    });

    {
      // first rendering
      expect(helper.getNumericRefinement('price', '>=')).toEqual(undefined);
      expect(helper.getNumericRefinement('price', '<=')).toEqual(undefined);
      var renderOptions = rendering.lastCall.args[0];
      var refine = renderOptions.refine;

      refine([10, 30]);
      expect(helper.getNumericRefinement('price', '>=')).toEqual([10]);
      expect(helper.getNumericRefinement('price', '<=')).toEqual([30]);
      expect(helper.search.callCount).toBe(1);
    }

    widget.render({
      results: new SearchResults(helper.state, [{
        hits: [{ test: 'oneTime' }],
        facets: { price: { 10: 1, 20: 1, 30: 1 } },
        facets_stats: { // eslint-disable-line
          price: {
            avg: 20,
            max: 30,
            min: 10,
            sum: 60
          }
        },
        nbHits: 1,
        nbPages: 1,
        page: 0
      }, {}]),
      state: helper.state,
      helper: helper,
      createURL: function createURL() {
        return '#';
      }
    });

    {
      // Second rendering
      expect(helper.getNumericRefinement('price', '>=')).toEqual([10]);
      expect(helper.getNumericRefinement('price', '<=')).toEqual([30]);
      var _renderOptions = rendering.lastCall.args[0];
      var _refine = _renderOptions.refine;

      _refine([23, 27]);
      expect(helper.getNumericRefinement('price', '>=')).toEqual([23]);
      expect(helper.getNumericRefinement('price', '<=')).toEqual([27]);
      expect(helper.search.callCount).toBe(2);
    }
  });
});